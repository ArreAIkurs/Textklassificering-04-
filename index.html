<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <title>Sentimentanalys</title>
</head>

<body>
    <h2>Analys av text (positiv/negativ)</h2>

    <textarea id="inputText" rows="5" cols="50"
              placeholder="Skriv recension..."></textarea>
    <br><br>

    <button onclick="analyze()">Analysera</button>

    <h3>Resultat:</h3>
    <div id="output">Modell laddas…</div>

    <!-- RÄTT TensorFlow.js -->
    https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js</script>

    <script>
        let model;
        let maxLen = 256;
        let vocabSize = 10000;

        async function loadEverything() {
            try {
                // Ladda TFJS-modell
                model = await tf.loadLayersModel("model.json");

                document.getElementById("output").innerText =
                    "Modell laddad ✔";

            } catch (err) {
                document.getElementById("output").innerText =
                    "Kunde inte ladda modell.";
                console.error(err);
            }
        }

        // Fallback-tokenizer (använder enkel hashing)
        function tokenize(text) {
            text = text.toLowerCase().replace(/[^a-zåäö0-9]+/g, " ").trim();
            const words = text.split(/\s+/);

            let seq = words.map(w => {
                // Hash → index inom [1, vocabSize)
                let hash = 0;
                for (let i = 0; i < w.length; i++) {
                    hash = (hash * 31 + w.charCodeAt(i)) % vocabSize;
                }
                return hash;
            });

            // Padding: längst bak blir början
            let padded = new Array(maxLen).fill(0);
            let start = Math.max(0, maxLen - seq.length);

            for (let i = 0; i < Math.min(seq.length, maxLen); i++) {
                padded[start + i] = seq[seq.length - Math.min(seq.length, maxLen) + i];
            }

            return tf.tensor2d([padded]);
        }

        async function analyze() {
            const text = document.getElementById("inputText").value;
            if (!text.trim()) {
                document.getElementById("output").innerText =
                    "Skriv text först!";
                return;
            }

            const input = tokenize(text);

            const pred = model.predict(input);
            const prob = (await pred.data())[0];

            const label = prob >= 0.5 ? "Positiv" : "Negativ";

            document.getElementById("output").innerHTML =
                `${label}<br><br>Sannolikhet: ${(prob * 100).toFixed(1)} %`;

            input.dispose();
            pred.dispose();
        }

        loadEverything();
    </script>

</body>
</html>
