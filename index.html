<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Sentimentanalys</title>
</head>

<body>
    <h2>Analys av text (positiv/negativ)</h2>

    <textarea id="inputText" rows="5" cols="50"
              placeholder="Skriv recension hÃ¤r..."></textarea>
    <br><br>

    <button onclick="analyze()">Analysera</button>

    <h3>Resultat:</h3>
    <div id="output">â€“</div>

    <!-- ðŸ”¥ RÃ„TT TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

    <script>
        let model;
        let metadata;
        let wordIndex = {};
        let maxLen = 100;
        let oov = 1;

        // ðŸ”¥ Ladda modell + metadata
        async function loadModel() {
            try {
                model = await tf.loadLayersModel("model.json");
                metadata = await fetch("metadata.json").then(r => r.json());

                wordIndex = metadata.word_index;
                maxLen = metadata.max_len;
                oov = wordIndex[metadata.oov_token] || 1;

                document.getElementById("output").innerText = "Modell laddad.";
            } catch (e) {
                document.getElementById("output").innerText =
                    "Kunde inte ladda modell/metadata.";
                console.error(e);
            }
        }

        // ðŸ”¥ Tokenisering + padding
        function textToTensor(text) {
            text = text.toLowerCase().replace(/[^a-zÃ¥Ã¤Ã¶0-9]+/g, " ").trim();
            const tokens = text.split(" ");

            let seq = tokens.map(t =>
                wordIndex[t] ? wordIndex[t] : oov
            );

            let padded = new Array(maxLen).fill(0);
            let start = Math.max(0, maxLen - seq.length);

            for (let i = 0; i < Math.min(seq.length, maxLen); i++) {
                padded[start + i] = seq[seq.length - Math.min(seq.length, maxLen) + i];
            }

            return tf.tensor2d([padded]);
        }

        // ðŸ”¥ Analys
        async function analyze() {
            const text = document.getElementById("inputText").value;
            const input = textToTensor(text);

            const output = model.predict(input);
            const prob = (await output.data())[0];

            document.getElementById("output").innerHTML =
                prob >= 0.5
                    ? `Positiv (${(prob * 100).toFixed(1)}%)`
                    : `Negativ (${(prob * 100).toFixed(1)}%)`;

            input.dispose();
            output.dispose();
        }

        // ðŸš€ Ladda vid start
        loadModel();
    </script>
</body>
</html>
